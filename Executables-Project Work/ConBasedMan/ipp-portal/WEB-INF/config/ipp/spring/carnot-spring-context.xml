<?xml version="1.0" encoding="UTF-8"?><!--    Copyright (c) 2011, 2012 SunGard CSA LLC and others.    All rights reserved. This program and the accompanying materials    are made available under the terms of the Eclipse Public License v1.0    which accompanies this distribution, and is available at    http://www.eclipse.org/legal/epl-v10.html    Contributors:       SunGard CSA LLC - initial API and implementation and/or initial documentation -->
<!--
   - Application context for a Infinity Process Engine client.
-->
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:jee="http://www.springframework.org/schema/jee"   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd      http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd">

   <!-- Infinity Process Platform Global Configuration -->

   <!-- Resolves ${...} placeholders from carnot.properties -->
   <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
      <property name="location" value="classpath:carnot.properties" />
   </bean>

   <bean id="carnotAuditTrailDataSource" class="org.springframework.jndi.JndiObjectFactoryBean">
      <property name="jndiName" value="java:comp/env/jdbc/AuditTrail.DataSource" />
   </bean>

   <bean id="carnotXaAuditTrailDataSource" class="org.apache.derby.jdbc.EmbeddedXADataSource">
      <property name="databaseName" value="carnot" />
      <property name="user" value="carnot" />
      <property name="password" value="ag" />
   </bean>

   <!-- adjust to whatever TX manager is required -->
   <!--alias alias="carnotTxManager" name="carnotDataSourceTxManager" /-->
   <alias alias="carnotTxManager" name="jtaTxManager" />

   <bean id="carnotDataSourceTxManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
      <property name="dataSource" ref="carnotAuditTrailDataSource" />
   </bean>

   <!-- Can be used to override settings from carnot.properties -->
   <bean id="customCarnotProperties"
      class="org.springframework.beans.factory.config.PropertiesFactoryBean">
      <property name="properties">
         <props>
<!--
            <prop key="AuditTrail.Type">DERBY</prop>
 -->
         </props>
      </property>
   </bean>


   <!-- Infinity Process Platform API -->


   <bean id="carnotWorkflowService" parent="abstractPublicCarnotService"
      class="org.eclipse.stardust.engine.api.spring.WorkflowServiceBean" />

   <bean id="carnotUserService" parent="abstractPublicCarnotService"
      class="org.eclipse.stardust.engine.api.spring.UserServiceBean" />

   <bean id="carnotQueryService" parent="abstractPublicCarnotService"
      class="org.eclipse.stardust.engine.api.spring.QueryServiceBean" />

   <bean id="carnotAdministrationService" parent="abstractPublicCarnotService"
      class="org.eclipse.stardust.engine.api.spring.AdministrationServiceBean" />

   <bean id="carnotDocumentManagementService" parent="abstractPublicCarnotService"
      class="org.eclipse.stardust.engine.api.spring.DocumentManagementServiceBean" />

   <bean id="carnotReportingService"      parent="abstractPublicCarnotService"      class="org.eclipse.stardust.reporting.rt.service.spring.ReportingServiceBean" />
   <!-- Infinity Process Platform Internals -->


   <bean abstract="true" id="abstractCarnotService"
      class="org.eclipse.stardust.engine.api.spring.AbstractSpringServiceBean">

      <property name="carnotProperties" ref="customCarnotProperties" />

      <property name="transactionManager" ref="carnotTxManager" />

      <property name="dataSource" ref="xaAuditTrailConnectionFactory" />
	  <property name="jcaResourceProvider" ref="carnotJcaResourceResolver" />   </bean>   	<bean name="carnotJcaResourceResolver"		class="org.eclipse.stardust.engine.spring.integration.jca.DefaultJcaResourceResolver" />

   <bean abstract="true" name="abstractPublicCarnotService" parent="abstractCarnotService">
      <!--property name="principalProvider" ref="whatever" /-->
   </bean>

   <bean id="carnotForkingService" parent="abstractCarnotService"
      class="org.eclipse.stardust.engine.api.spring.QueuedSpringForkingService">

      <property name="jobManager" ref="carnotAsyncJobManager" />

   </bean>

   <bean id="carnotAsyncJobManager" class="org.eclipse.stardust.engine.spring.threading.FiFoJobManager"
      scope="singleton">

      <property name="maxParallelJobs" value="10" />

      <property name="useShutdownHook" value="true" />

   </bean>

   <!-- JTA TX manager for i.e. Tomcat -->

   <bean id="jtaTxManager" class="org.springframework.transaction.jta.JtaTransactionManager">
      <property name="userTransaction" ref="xaTransactionManager" />
   </bean>

	<bean name="xaTransactionManager" class="org.jencks.factory.TransactionManagerFactoryBean" />

   <bean id="jencksConnectionManager" class="org.jencks.factory.ConnectionManagerFactoryBean">

      <property name="transactionManager" ref="xaTransactionManager" />

      <property name="transaction" value="xa" />

      <!--property name="connectionTracker">
         <bean class="org.apache.geronimo.connector.outbound.connectiontracking.ConnectionTrackingCoordinator" />
      </property-->
   </bean>

   <bean id="xaAuditTrailConnectionFactory" class="org.springframework.jca.support.LocalConnectionFactoryBean">
      <property name="managedConnectionFactory">
         <bean class="org.eclipse.stardust.engine.core.persistence.jca.XaDataSourceMCF">
            <constructor-arg index="0" ref="carnotXaAuditTrailDataSource" />
         </bean>
      </property>
      <property name="connectionManager" ref="jencksConnectionManager" />
   </bean></beans>
